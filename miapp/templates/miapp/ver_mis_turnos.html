{% extends 'miapp/base_ventas.html' %}
{% load static %}
{% block title %}
    {{ titulo }}
{% endblock title %}

<head>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.css">
</head>

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <ul class="nav nav-pills mb-0">
                            <li class="nav-item">
                                <a class="nav-link active" id="calendar-tab" data-bs-toggle="pill" href="#calendar">
                                    <i class="fas fa-calendar-alt"></i> Calendario
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="list-tab" data-bs-toggle="pill" href="#list">
                                    <i class="fas fa-list"></i> Listado de Turnos
                                </a>
                            </li>
                        </ul>
                        <ol class="breadcrumb mb-0 ms-auto">
                            <li class="breadcrumb-item"><a href="{% url 'home_ventas' %}"><i class="fas fa-home"></i> Inicio</a></li>
                            <li class="breadcrumb-item active">Mis Turnos</li>
                        </ol>
                    </div>
                    <div class="card-body p-4">
                        <div class="tab-content">
                            <!-- Calendario -->
                            <div class="tab-pane fade show active" id="calendar">
                                <div id="calendar"></div>
                            </div>

                            <!-- Listado -->
                            <div class="tab-pane fade" id="list">
                                <h2><i class="fas fa-calendar-check"></i> Mis Turnos Detallados</h2>
                                <div class="table-responsive">
                                    <table id="example1" class="table table-striped table-bordered table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>ID Orden</th>
                                                <th>Cliente</th>
                                                <th>Fecha</th>
                                                <th>Duración</th>
                                                <th>Productos</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for turno in turnos %}
                                                <tr>
                                                    <td>{{ turno.id }}</td>
                                                    <td>{{ nombre_cliente }}</td>
                                                    <td>{{ turno.fecha_hora|date:"d/m/Y H:i" }}</td>
                                                    <td>{{ turno.duracion }} minutos</td>

                                                    <td>
                                                        {% if turno.productos_list %}
                                                            {% for producto in turno.productos_list %}
                                                                <span class="badge bg-info">{{ producto.nombre }}</span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="badge bg-secondary">No hay productos cargados</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'turno_detail_cliente' turno.id %}" class="btn btn-info btn-sm mb-2" style="width: 120px;">
                                                            <i class="fas fa-eye"></i> Ver Turno
                                                        </a>
                                                        <a href="{% url 'turno_delete' turno.id %}" class="btn btn-danger btn-sm mb-2" style="width: 120px;">
                                                            <i class="fas fa-trash-alt"></i> Eliminar
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center">No tienes turnos agendados.</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/adminlte-master/plugins/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'lib/adminlte-master/plugins/datatables/jquery.dataTables.min.js'%}"></script>
    <script src="{% static 'lib/adminlte-master/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js'%}"></script>
    <script src="{% static 'lib/adminlte-master/plugins/datatables-responsive/js/dataTables.responsive.min.js'%}"></script>
    <script src="{% static 'lib/adminlte-master/plugins/datatables-responsive/js/responsive.bootstrap4.min.js'%}"></script>

    <script>
        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar-modern');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // Parallax effect for floating shapes
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;
            const shapes = document.querySelectorAll('.shape');
            
            shapes.forEach((shape, i) => {
                const speed = 0.3 + (i * 0.1);
                shape.style.transform = `translateY(${scrolled * speed}px) rotate(${scrolled * 0.05}deg)`;
            });
        });

        // Smooth animations on load
        document.addEventListener('DOMContentLoaded', function() {
            // Add animation classes when elements come into view
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // Observe all cards and sections
            document.querySelectorAll('.card-modern, .footer-modern > *').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'all 0.6s ease';
                observer.observe(el);
            });
        });

        // Enhanced dropdown behavior and positioning
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const toggle = dropdown.querySelector('.dropdown-toggle');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            if (toggle && menu) {
                let isHovering = false;
                let hoverTimeout;
                
                // Position dropdown correctly on click
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const rect = toggle.getBoundingClientRect();
                    const menuRect = menu.getBoundingClientRect();
                    const windowWidth = window.innerWidth();
                    
                    // Check if dropdown would go off-screen to the right
                    if (rect.right + menuRect.width > windowWidth) {
                        menu.classList.add('dropdown-menu-end');
                        menu.style.right = '0';
                        menu.style.left = 'auto';
                    }
                    
                    // Toggle dropdown
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                        setTimeout(() => {
                            if (!menu.classList.contains('show')) {
                                menu.style.display = 'none';
                            }
                        }, 150);
                    } else {
                        // Close other dropdowns first
                        document.querySelectorAll('.dropdown-menu.show').forEach(otherMenu => {
                            if (otherMenu !== menu) {
                                otherMenu.classList.remove('show');
                                setTimeout(() => {
                                    if (!otherMenu.classList.contains('show')) {
                                        otherMenu.style.display = 'none';
                                    }
                                }, 150);
                            }
                        });
                        
                        menu.style.display = 'block';
                        setTimeout(() => {
                            menu.classList.add('show');
                        }, 10);
                    }
                });
                
                // Mouse hover behavior for desktop
                if (window.innerWidth > 768) {
                    // Show dropdown on hover
                    function showDropdown() {
                        clearTimeout(hoverTimeout);
                        isHovering = true;
                        
                        // Close other dropdowns
                        document.querySelectorAll('.dropdown-menu.show').forEach(otherMenu => {
                            if (otherMenu !== menu) {
                                otherMenu.classList.remove('show');
                                setTimeout(() => {
                                    if (!otherMenu.classList.contains('show')) {
                                        otherMenu.style.display = 'none';
                                    }
                                }, 150);
                            }
                        });
                        
                        menu.style.display = 'block';
                        setTimeout(() => {
                            menu.classList.add('show');
                        }, 10);
                    }
                    
                    // Hide dropdown with delay
                    function hideDropdown() {
                        isHovering = false;
                        hoverTimeout = setTimeout(() => {
                            if (!isHovering) {
                                menu.classList.remove('show');
                                setTimeout(() => {
                                    if (!menu.classList.contains('show')) {
                                        menu.style.display = 'none';
                                    }
                                }, 150);
                            }
                        }, 300); // Increased delay to 300ms
                    }
                    
                    // Add hover events to toggle
                    toggle.addEventListener('mouseenter', showDropdown);
                    toggle.addEventListener('mouseleave', hideDropdown);
                    
                    // Add hover events to menu
                    menu.addEventListener('mouseenter', () => {
                        clearTimeout(hoverTimeout);
                        isHovering = true;
                    });
                    
                    menu.addEventListener('mouseleave', hideDropdown);
                    
                    // Keep dropdown open when hovering over items
                    menu.querySelectorAll('.dropdown-item-modern').forEach(item => {
                        item.addEventListener('mouseenter', () => {
                            clearTimeout(hoverTimeout);
                            isHovering = true;
                        });
                    });
                }
            }
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    setTimeout(() => {
                        if (!menu.classList.contains('show')) {
                            menu.style.display = 'none';
                        }
                    }, 150);
                });
            }
        });
    </script>
<script>
    // Inicializar calendario
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'es',
            events: [
                {% for turno in turnos %}
                    {
                        title: '{{ turno.productos.all.0.nombre|escapejs }}',
                        start: '{{ turno.fecha_hora|date:"Y-m-d\\TH:i:s" }}',
                        url: '{% url "turno_detail_cliente" turno.id %}',
                        color: '#17a2b8'
                    },
                {% endfor %}
            ],
            dayMaxEvents: 3
        });
        calendar.render();
    });

    // Inicializar DataTables
    $(document).ready(function () {
        $('#example1').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            columnDefs: [
                { targets: [0, 1, 2], searchable: true },
                { targets: [3], searchable: true },
                { targets: [4], searchable: false }
            ],
            language: {
                "url": "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es_es.json"
            }
        });
    });

    // Activar pestañas con Bootstrap 5
    const triggerTabList = document.querySelectorAll('.nav-link');
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            tabTrigger.show();
        });
    });
</script>
{% endblock content %}
